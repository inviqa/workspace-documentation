# Local Harness Pattern (Minimal Harness for `confd` Rendering)

> Status: Experimental usage pattern. This document describes how to leverage
> the existing harness lifecycle to render templates into a project **without**
> depending on a published upstream harness. It is a pragmatic workaround until
> a potential future `standaloneConfd` feature exists.

## Motivation

Sometimes you want:

- Templated file generation (Dockerfiles, env examples, config stubs)
- Access to Workspace attribute and expression rendering
- The ordering, Twig environment, and idempotency of the harness `confd` engine

…but you **do not** want to adopt or vendor an external harness (PHP, Node,
Drupal, etc.). The *Local Harness Pattern* creates the smallest possible harness
layer in-repo whose sole purpose is to register a `confd.yml` and any template
files. All outputs can be targeted directly at the project root via the
`workspace:/` destination prefix.

## When to Use (and When Not To)

| Use When | Avoid When |
|----------|------------|
| Simple templating + helper scripts | Need upstream updates (use real harness) |
| Deterministic generation, no stack | Need multi-layer inheritance |
| Avoid custom ad-hoc Twig scripting | Will soon adopt official base harness |
| Can tolerate `.my127ws/` dir | Cannot allow any ephemeral directory |

## Directory Layout

```text
workspace.yml
local-harness/
  config/
    confd.yml
  templates/
    docker/Dockerfile.twig
    env/app.env.twig
    notices/NOTICE.md.twig
```

You may choose different names; `local-harness` simply conveys intent.

## Defining the Local Harness in `workspace.yml`

```yaml
workspace('my-app'):
  harness:
    path: ./local-harness
  attributes:
    app:
      name: my-app
      php_version: 8.3
```

Key points:

- `path:` points to a directory treated as a harness layer (no vendor download).
- You can add attributes consumed by Twig templates.

## Minimal `confd.yml`

`local-harness/config/confd.yml`:

```yaml
confd('workspace:/'):
  - { src: templates/docker/Dockerfile }
  - { src: templates/env/app.env, dst: workspace:/.env.example }
  - { src: templates/notices/NOTICE.md, dst: workspace:/NOTICE.md }
```

### Why `workspace:/` Prefix?

It directs all rendered outputs into the project root (not the ephemeral
`.my127ws/` tree). This keeps cognitive load low: generated files appear where
developers expect them.

## Template Examples

`local-harness/templates/docker/Dockerfile.twig`

```dockerfile
FROM alpine:3.19
LABEL org.opencontainers.image.title="{{ app.name }}"
```

`local-harness/templates/env/app.env.twig`

```env
APP_NAME={{ app.name }}
PHP_VERSION={{ app.php_version }}
```

`local-harness/templates/notices/NOTICE.md.twig`

```markdown
# Local Build Assets
Generated by Local Harness via `ws harness prepare`.
```

## Running the Render Pipeline

Initial enable (creates `.my127ws/` and renders templates):

```bash
ws enable
```

Subsequent template or mapping changes (no re-download):

```bash
ws harness prepare
```

Resulting files in project root after first run:

```text
./Dockerfile
./.env.example
./NOTICE.md
```

## How It Works Internally

1. Workspace sees `harness.path` and treats that directory as the harness.

2. During `prepare` the installer invokes:

  ```php
  Installer::applyConfiguration($this->harness->getRequiredConfdPaths())
  ```

1. `getRequiredConfdPaths()` includes the harness root so `confd.yml` is parsed.

1. `confd('workspace:/')` mappings render directly to the root.

## Version Control Guidance

Add (or ensure) `.my127ws/` in your `.gitignore`; commit the **rendered** files
if they are part of the reproducible dev environment. Do *not* edit rendered
files—modify the Twig templates or mappings and re-run instead.

## Limitations

- Still produces `.my127ws/` (cannot be suppressed currently).
- No multi-layer override semantics beyond what you manually add (only one layer).
- Cannot (yet) declare additional standalone confd roots outside the harness path.
- Internal harness APIs may evolve; keep the pattern minimal to reduce churn.

## Migration to a Full Harness Later

If you later adopt an upstream harness:

1. Move local templates into an overlay directory or new layer.
2. Replace `harness.path` with vendor harness name (e.g. `inviqa/php`).
3. Merge `confd.yml` entries (avoid duplicate destinations).

## Comparison with Custom Command Approach

| Aspect | Local Harness | Custom Confd Command |
|--------|---------------|----------------------|
| Supported lifecycle | Yes (reuse prepare) | No (bespoke) |
| Maintenance risk | Low | Higher (internal APIs) |
| Additional code | None | Script + loader |
| Extensibility | Can grow into real harness | Must be rewritten |

## Future Direction (Potential Enhancement)

A future `workspace.yml` key (e.g. `standaloneConfd:`) could allow harness-less
confd paths. Until then, this pattern is the simplest supported approach.

## Quick Start Checklist

1. Create `local-harness/config/confd.yml` with `confd('workspace:/')` block.
2. Add templates under `local-harness/templates/` (omit `.twig` in `src`).
3. Reference harness via `harness.path` in `workspace.yml`.
4. Run `ws enable` → inspect generated files.
5. Iterate using `ws harness prepare` after template edits.

---

*See also:*

- [Harness File Materialisation (confd.yml)](harness-confd-file-mappings.md)
- [Workspace Commands & Functions Index](workspace-commands-functions-index.md)
